<!DOCTYPE html>
<html lang="en" >
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Drug Stock on Hand Report</title>
		<link href="../CSS/style.css" type="text/css" rel="stylesheet"/>
		<link rel="SHORTCUT ICON" href="../Images/favicon.ico">
		<link href="../Scripts/bootstrap/css/bootstrap.min.css" type="text/css" rel="stylesheet" media="screen"/>
		<link href="../CSS/offline_css.css" type="text/css" rel="stylesheet"/>
		<link href="../CSS/jquery-ui.css" type="text/css" rel="stylesheet"/>
		<link href="TableFilter/filtergrid.css" type="text/css" rel="stylesheet"/>
		
		<script type="text/javascript" src="../Scripts/jquery.js"></script>
		<script type="text/javascript" src="../Scripts/jquery-ui.js"></script>
		<script type="text/javascript" src="../Scripts/offline_database.js"></script>
		<script type="text/javascript" src="../Scripts/offlineData.js"></script>
		<script type="text/javascript" src="TableFilter/tablefilter_all.js"></script>
		<script>
			$(document).ready(function(){
				$.get('reports_include.html', function(data) {
				  $('.result').html(data);
				});
			});
		</script>
		<script type="text/javascript">
		
			$(document).ready(function() {
				initDatabase();
				var $_GET = getQueryParams(document.location.hash);
				var stock_type=$_GET['stock_type'];
				var count=0;
				var stocks_unconverted = 0;
				var soh_packs = 0;
				var minimum_stock = 0;
				var minimum_consumption = 0;
				var stock_status = 0;
				var type_title="";
				if(stock_type=="1"){
					type_title="Main Store";
				}
				else if(stock_type="2"){
					type_title="Pharmacy";
				}
				var d = new Date();
				var dat = ("0" + d.getDate()).slice(-2);
				var year = d.getFullYear();
				var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
				var mon = monthNames[d.getMonth()];
				var theday = dat + "-" + mon + "-" + year;
				
				var counter=0;
				$("#theday").val(theday);

				//Get the environmental variables to display the hospital name
				selectEnvironmentVariables(function(transaction, results) {
					// Handle the results
					var row = results.rows.item(0);
					$("#facility_name").text(row['facility_name'] +" - "+type_title);
					var facility = row['facility'];
					//Retrieve all drugs in the database
					var drugs_sql = "select '" + facility + "' as facility,d.id as id,drug, pack_size, name from drugcode d left join drug_unit u on d.unit = u.id where d.Enabled=1";

					var drug_statistics;
					SQLExecuteAbstraction(drugs_sql, function(transaction, results) {
						for(var i = 0; i < results.rows.length; i++) {
							var parent_row = results.rows.item(i);
							getDrugInfo(parent_row['facility'], parent_row['id'], parent_row['drug'], parent_row['name'], parent_row['pack_size']);
							
						}

					});
				});
				function getDrugInfo(facility, drug, drug_name, drug_unit, drug_packsize) {
					var stock_param="";
					//Store
					if(stock_type=='1'){
						stock_param=" AND (source='"+facility+"' OR destination='"+facility+"') AND source!=destination ";
					}
					//Pharmacy
					else if(stock_type=='2'){
						stock_param=" AND (source=destination) AND(source='"+facility+"') ";
					}
					
					var stock_status = 0;
					var counter = 0;
					var batch_status_row_string = "";
					//Query to get all batches that have not expired
					var all_batches = "SELECT DISTINCT d.batch_number AS batch FROM drug_stock_movement d WHERE d.drug =  '" + drug + "' AND expiry_date > date() AND facility='" + facility + "' "+stock_param+" GROUP BY d.batch_number";
					SQLExecuteAbstraction(all_batches, function(transaction, results) {
						for(var k = 0; k < results.rows.length; k++) {
							var all_batches_count = results.rows.length;
							var batch_row = results.rows.item(k);
							batch_no = batch_row['batch'];
							//Query to check if batch has had a physical count
							var initial_stock_sql = "SELECT SUM( d.quantity ) AS Initial_stock, d.transaction_date AS transaction_date, '" + batch_no + "' AS batch,'" + k + "' AS counter FROM drug_stock_movement d WHERE d.drug =  '" + drug + "' AND transaction_type =  '11' AND facility='" + facility + "' "+stock_param+" AND d.batch_number =  '" + batch_no + "'";

							SQLExecuteAbstraction(initial_stock_sql, function(transaction, results) {
								for(var m = 0; m < results.rows.length; m++) {

									var physical_row = results.rows.item(m);
									initial_stock = physical_row['Initial_stock'];
									//Check if initial stock is present meaning physical count done
									if(initial_stock != null) {
										batch_stock_sql = "SELECT (SUM( ds.quantity ) - SUM( ds.quantity_out )) AS stock_levels, '" + physical_row['counter'] + "' AS counter, ds.batch_number FROM drug_stock_movement ds WHERE ds.transaction_date BETWEEN  '" + physical_row['transaction_date'] + "' AND date() AND facility='" + facility + "' "+stock_param+" AND ds.drug ='" + drug + "'  AND ds.batch_number ='" + physical_row['batch'] + "'";
										SQLExecuteAbstraction(batch_stock_sql, function(transaction, results) {
											for(var j = 0; j < results.rows.length; j++) {
												var second_row = results.rows.item(j);
												if(second_row['stock_levels'] > 0) {
													stock_status += second_row['stock_levels'];

												}
												if(second_row['counter'] == (all_batches_count - 1)) {
													getSafetyStock(drug, stock_status, drug_name, drug_unit, drug_packsize);
												}
											}
											
											
										});
									} else {
										batch_stock_sql = "SELECT (SUM( ds.quantity ) - SUM( ds.quantity_out ) ) AS stock_levels, '" + physical_row['counter'] + "' AS counter, ds.batch_number FROM drug_stock_movement ds WHERE ds.drug =  '" + drug + "' AND ds.expiry_date > date() AND facility='" + facility + "' "+stock_param+" AND ds.batch_number='" + physical_row['batch'] + "'";
										//console.log(batch_stock_sql)
										SQLExecuteAbstraction(batch_stock_sql, function(transaction, results) {
											for(var j = 0; j < results.rows.length; j++) {
												var second_row = results.rows.item(j);
												if(second_row['stock_levels'] > 0) {
													stock_status += second_row['stock_levels'];

												}
												if(second_row['counter'] == (all_batches_count - 1)) {
													getSafetyStock(drug, stock_status, drug_name, drug_unit, drug_packsize);
												}

											}
											
										});
										
									}

								}

							});
						}

					});
				}
				
				function getSafetyStock(drug, stock_status, drug_name, drug_unit, drug_packsize) {
					
					//Get Details about Drug Stock_in
					getDrugMonthlyConsumption(drug,stock_type, function(transaction, results) {
						// Handle the results
						if(results.rows.length == 0) {
							var three_monthly_consumption = 0;

						} else {
							for(var i = 0; i < results.rows.length; i++) {
								var row = results.rows.item(i);
								//For last three months
								var three_monthly_consumption = row["TOTAL"];

							}
						}
						//Calculating Monthly Consumption hence Max-Min Inventory

						monthly_consumption = (three_monthly_consumption) / 3;
						var month_avg = monthly_consumption.toFixed(2);
						var formatted_month_avg = numberWithCommas(month_avg);

						//var avg_row_string = "<tr><td>" + formatted_month_avg + "</td></tr>";
						//$("#avg_consumption").append($(avg_row_string));

						//Therefore Maximum Consumption
						var maximum_consumption = monthly_consumption * 3;
						var formatted_maximum_consumption = numberWithCommas(maximum_consumption);
						//var max_row_string = "<tr><td>" + formatted_maximum_consumption + "</td></tr>";
						//$("#maximum_consumption").append($(max_row_string));

						//Therefore Minimum Consumption
						var minimum_consumption = monthly_consumption * 1.5;
						var formatted_minimum_consumption = numberWithCommas(minimum_consumption);
						//var min_row_string = "<tr><td>" + formatted_minimum_consumption + "</td></tr>";
						//$("#minimum_consumption").append($(min_row_string));
						//$("#minimum_consumption").attr('style', "background:red;font-weight:bold;color:#000;");
						counter++;
						var x="";
						if(counter%2==0){
							x="class='_even'";
						}
						else{
							x="class='_odd'";
						}
						finalAnswer(stock_status, minimum_consumption, drug_name, drug_unit, drug_packsize,x);
							
					});
				}
				
				function numberWithCommas(x) {
					return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
				}
				function finalAnswer(stock_status, minimum_consumption, drug_name, drug_unit, drug_packsize,x) {
					var stocks_unconverted = stock_status;
					var stocks_in_units = numberWithCommas(stock_status);

					//divides actual stocks by packsize

					var soh_packs = (stocks_unconverted / drug_packsize);
					if(isNaN(soh_packs) == false) {
						var thepacks = soh_packs.toFixed(1);
					} else {
						var thepacks = " ";
					}
					var minimum_stock = minimum_consumption;

					if(stocks_unconverted < minimum_stock) {
						var the_alert = "LOW";
					} else {
						var the_alert = " ";
					}
					var packsize = numberWithCommas(drug_packsize);
					var safetystock = numberWithCommas(minimum_stock);
					var stock_in_packs = numberWithCommas(thepacks);

					var row_string = "<tr "+x+"><td align='left'>" + drug_name + "</td><td align='left'>" + drug_unit + "</td><td align='center'>" + packsize + "</td><td align='center'>" + stocks_in_units + "</td><td align='center'>" + stock_in_packs + "</td><td align='center'>" + safetystock + "</td><td align='center'>" + the_alert + "</td></tr>";
					
					$("#drug_listing").append($(row_string));
					count++;
					
				}
				
				var check_count=0;
				var previous_check_count=0;
				var z=0;
				var interval=setInterval(function() {
					previous_check_count=count;
					if(check_count==0){
						check_count=previous_check_count;
					}
					else{
						if(previous_check_count==check_count){
							if(z==0){
								z=1;
							}
							else if(z==1){
								clearInterval(interval);
								tableFilterDrugListing();
							}
							
						}
						else{
							z=0;
							check_count=previous_check_count;
						}
					}
					
				}, 3000);

			});
			
			
			
			function tableFilterDrugListing() {

					var props = {
						sort : true,
						//remember_grid_values : true,
						remember_page_number : true,
						//remember_page_length : true,
						filters_row_index : 1,
						alternate_rows : true,
						rows_counter : true,
						rows_counter_text : "Displayed rows: ",
						btn_reset : true,
						btn_reset_text : "Clear",
						loader : true,
						//status_bar : true,
						//btn_reset_text : "Clear",
						fixed_headers: true,
						mark_active_columns : true,
						col_0 : "select",
						col_1 : "select",
						col_2 : "select",
						col_3 : "select",
						col_4 : "select",
						col_5 : "select",
						col_6 : "select",
						col_7 : "select",
						paging:true,
						results_per_page : ['Results per page', [10, 25, 50, 100, 500,1000]],
			
						display_all_text : "< Show All >",
			
						col_width : ["300px", "90px", "120px", "130px", "120px", "120px", "120px", "120px"],
			
						//Column resize feature
						extensions : {
							name : ['ColumnsResizer'],
							src : ['TableFilter/TFExt_ColsResizer/TFExt_ColsResizer.js'],
							description : ['Columns Resizing'],
							initialize : [
							function(o) {
								o.SetColsResizer();
							}]
			
						},
						col_resizer_all_cells : false
					}
					var tf = setFilterGrid("drug_listing", props);
				}
			
		</script>
	</head>
	<body>
		<style>
			body{
				margin-bottom:20px;
			}
			#drug_listing {
				margin: 0 auto;
				border: 1px solid #B9B9B9;
				font-size: 14px;
				letter-spacing: 1px;
				border: 1px solid #000;
				border-top:none;
			}
			#drug_listing td th {
				padding: 10px;
			
				
			}
			#drug_listing table{
				border-collapse:collapse;
				width:1200px;
			}
			/* Sortable tables */
			table.sortable thead {
				background-color: #CFF;
				font-weight: bold;
				cursor: default;
				font-size:16px;
			}
			
			#drug_listing td,#drug_listing th{
				border:1px solid #000;
				padding: 5px;
			}
			
			.inf{
				border-bottom: none;
			}
			select.pgSlc{
				height:30px;
				width:60px;
			}
			select.flt {
				font-size: 14px;
			}
			#theday{
				color: rgb(45, 173, 13);
				font-size:14px;
				border:none;
				font-weight: 800;
				width:110px;
				padding-bottom:0px;
				height:25px;
			}
			#theday:hover{
				cursor:pointer;
			}
			.stock_type_title{
				font-size:20px;
				font-weight:bolder;
				color:rgb(0, 197, 0);
			}
			
		</style>
		
		<!-- Menus -->
		<div class="navbar ">
		  <div class="navbar-inner">
		    <div class="container">
		 
		      <!-- Everything you want hidden at 940px or less, place within here -->
		      <div class="nav-collapse collapse" id="acdmenu">
		      	<a class="brand" href="../reports.html"/><img src="../Images/home-icon.png"> | </a>
		        <ul class="nav">
				  <li class="dropdown">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="standard_report">
				     Standard Reports
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="standard_report_sub">
				      <li><a href="#" id="patients_enrolled_in_period" class="report donor_date_range_report active_report">Number of Patients Enrolled in Period</a></li>
				      <li><a href="#" id="patients_enrolled_in_art" class="report donor_date_range_report active_report">Number of Patients Started on ART in the Period</a></li>
				      <li><a href="#" id="graph_patients_enrolled_in_year" class="report active_report annual_report">Graph of Number of Patients Enrolled Per Month in a Given Year</a></li>
				      <li><a href="#" id="cumulative_patients" class="report active_report single_date_report">Cumulative Number of Patients to Date</a></li>
				      <li><a href="#" id="patients_on_ART_active" class="report active_report single_date_report">Number of Active Patients Receiving ART (by Regimen)</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical" id="visiting_patient">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
				     Visiting Patients
				    <b class="caret"></b>
				    </a>
				     <ul class="dropdown-menu" id="visiting_patient_sub">
				      <li><a href="#" id="patients_scheduled_to_visit" class="report active_report date_range_report">List of Patients Scheduled to Visit</a></li>
				      <li><a href="#" id="patients_started_on_date" class="report active_report date_range_report">List of Patients Started (on a Particular Date)</a></li>
				      <li><a href="#" id="patients_visitied_for_refill" class="report active_report date_range_report">List of Patients Visited for Refill</a></li>
				      <li><a href="#" id="patients_missing_appointments" class="report active_report date_range_report">Patients Missing Appointments</a></li>
				      <li><a href="#" id="patients_adherence" class="report active_report date_range_report">Patients Adherence Report</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="early_warning">
				     Early Warning Indicators
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu " id="early_warning_sub">
				      <li><a href="#" id="patients_who_changed_regimen" class="report active_report date_range_report">Active Patients who Have Changed Regimens</a></li>
				      <li><a href="#" id="patients_starting" class="report active_report date_range_report">List of Patients Starting (By Regimen)</a></li>
				      <li><a href="#" id="early_warning_indicators" class="report active_report date_range_report">HIV Early Warning Indicators</a></li>
				      <li><a href="#" id="service_statistics" class="report active_report single_date_report">Service Statistics (By Regimen)</a></li>
				     
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="drug_inventory">
				     Drug Inventory
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="drug_inventory_sub">
				      <li><a href="#" id="drug_consumption" class="report active_report annual_report">Drug Consumption Report</a></li>
				      <li><a href="#" id="drug_stock_on_hand" class="report active_report no_filter">Drug Stock on Hand Report</a></li>
				      <li><a href="#" id="commodity_summary" class="report active_report date_range_report">Facility Summary Commodity Report</a></li>
				      <li><a href="#" id="expiring_drugs" class="report active_report no_filter">Short Dated Stocks &lt;6 Months to Expiry</a></li>
				      <li><a href="#" id="expired_drugs" class="report active_report no_filter">List of Expired Drugs</a></li>
				    </ul>
				  </li>
				</ul>
		        <a onClick="window.print()" class="brand" title="Print this page"/> | <img src="../Images/printing_icon.png"> </a>
		      </div>
		 
		    </div>
		  </div>
		</div>
		<!-- Menus end -->
		
		<h2 id="facility_name" style="text-align: center"></h2>
		<h4 style="text-align: center">Report on Inventory Status as of<input type="text" class="_date" id="theday"> (in Packs)</h4>
		<hr size="1" style="width:80%">
		
		<table   id="drug_listing" class="sortable">
			<thead>
				<tr>
					<th> Drug </th>
					<th> Unit </th>
					<th> Pack Size </th>
					<th> Stocks in Units </th>
					<th> SOH in Packs</th>
					<th> Safety Stocks </th>
					<th> Stock Status</th>
				</tr>
			</thead>
			
		</table>
		<input type="hidden" id="stock_status" />
		
		<!-- Pop up Window -->
		<div class="result"></div>
		<!-- Pop up Window end-->
		
		
	</body>
</html>