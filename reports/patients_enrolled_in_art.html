<!DOCTYPE html>
<html lang="en" >
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Patients Started on ART in Period</title>
		<link href="../CSS/style.css" type="text/css" rel="stylesheet"/>
		<link rel="SHORTCUT ICON" href="../Images/favicon.ico">
		<link href="../Scripts/bootstrap/css/bootstrap.min.css" type="text/css" rel="stylesheet" media="screen"/>
		<link href="../CSS/offline_css.css" type="text/css" rel="stylesheet"/>
		<link href="../CSS/jquery-ui.css" type="text/css" rel="stylesheet"/>
		<link href="TableFilter/filtergrid.css" type="text/css" rel="stylesheet"/>
		<script type="text/javascript" src="../Scripts/jquery.js"></script>
		<script type="text/javascript" src="../Scripts/jquery-ui.js"></script>
		<script type="text/javascript" src="../Scripts/offline_database.js"></script>
		<script type="text/javascript" src="../Scripts/offlineData.js"></script>
		<script type="text/javascript" src="TableFilter/tablefilter_all.js"></script>
		<script>
			$(document).ready(function(){
				$.get('reports_include.html', function(data) {
				  $('.result').html(data);
				});
			});
		</script>
		<script type="text/javascript">
			$(document).ready(function() {
				initDatabase();
				//Get the environmental variables to display the hospital name
				selectEnvironmentVariables(function(transaction, results) {
					var $_GET = getQueryParams(document.location.hash);
					var start_date = $_GET['start_date'];
					var end_date = $_GET['end_date'];
					var supported_by = $_GET['donor'];
					$("#start_date").val($.datepicker.formatDate('dd-M-yy', new Date(start_date)));
					$("#end_date").val($.datepicker.formatDate('dd-M-yy', new Date(end_date)));

					// Handle the results
					var row = results.rows.item(0);
					$("#facility_name").text(row['facility_name']);
					var facility = row['facility'];

					//Check supported by

					if(supported_by == 0) {
						supported_query = "AND(supported_by=1 OR supported_by=2) AND facility_code='" + facility + "'";
					}
					if(supported_by == 1) {
						supported_query = "AND supported_by=1 AND facility_code='" + facility + "'";
					}
					if(supported_by == 2) {
						supported_query = "AND supported_by=2 AND facility_code='" + facility + "'";
					}

					var sql = "select count(*) as total from patient where date(start_regimen_date) between date('" + start_date + "') and date('" + end_date + "') and service=1  " + supported_query + "";
					console.log(sql);
					SQLExecuteAbstraction(sql, function(transaction, results) {
						// Handle the results
						var parent_row = results.rows.item(0);
						if(parent_row['total'] == 0) {
							var batch_status_row_string = "<tr><td colspan='12' align='center'><b><h4>No Patients Enrolled in this period</h4></b></td></tr>";
							$("#patient_listing").append($(batch_status_row_string));
						}
						var total_patients = parent_row['total'];
						var total_adult_male_art = 0;
						var total_adult_male_pep = 0;
						var total_adult_male_oi = 0;
						var total_adult_female_art = 0;
						var total_adult_female_pep = 0;
						var total_adult_female_pmtct = 0;
						var total_adult_female_oi = 0;
						var total_child_male_art = 0;
						var total_child_male_pep = 0;
						var total_child_male_pmtct = 0;
						var total_child_male_oi = 0;
						var total_child_female_art = 0;
						var total_child_female_pep = 0;
						var total_child_female_pmtct = 0;
						var total_child_female_oi = 0;
						


						var regimen_totals = new Array();
						//Now get all the patient statuses
						getRegimenTotals(start_date, end_date, function(transaction, results0) {
							for(var x = 0; x < results0.rows.length; x++) {
								var parent_row = results0.rows.item(x);
								
								
								var returned_counter = 0;
								regimen_totals[parent_row['start_regimen']] = parent_row['total'];
								//for each patient status, get it's statistics
								//start with the adult male
								getRegimenStatisticNumbers(start_date, end_date, "adult", "1", parent_row['start_regimen'], parent_row['regimen_desc'], function(transaction, results) {
									var regimen_details = results.rows.item(0);
									var passed_regimen = regimen_details['passed_regimen'];
									var passed_regimen_name = regimen_details['passed_regimen_name'];
									if((x%2)==0){
										var row_string = "<tr class='even'><td>" + passed_regimen_name + "</td><td>" + regimen_totals[passed_regimen] + "</td><td>" + (Math.ceil(100 * ((regimen_totals[passed_regimen] / total_patients) * 100)) / 100) + "</td>";
									}
									else{
										var row_string = "<tr class='odd'><td>" + passed_regimen_name + "</td><td>" + regimen_totals[passed_regimen] + "</td><td>" + (Math.ceil(100 * ((regimen_totals[passed_regimen] / total_patients) * 100)) / 100) + "</td>";
									}
									counter = 0;
									for(var i = 1; i <= 2; i++) {
										counter++;
										try {
											var adult_male_row = results.rows.item(i);
											if(adult_male_row['name'] != null) {
												total_adult_male_art += adult_male_row['total'];
												row_string += "<td>" + adult_male_row['total'] + "</td><td>" + (Math.ceil(100 * ((adult_male_row['total'] / regimen_totals[passed_regimen]) * 100)) / 100) + "</td>";
											} else {
												row_string += "<td>-</td>";
											}
										} catch(e) {
											if(counter <= 1) {
												row_string += "<td>-</td><td>-</td>";
											}
										}
									}
									getRegimenStatisticNumbers(start_date, end_date, "adult", "2", passed_regimen, passed_regimen_name, function(transaction2, results2) {
										counter = 0;
										for(var i = 1; i <= 2; i++) {
											counter++;
											try {
												var adult_female_row = results2.rows.item(i);
												if(adult_female_row['name'] != null) {
													total_adult_female_art += adult_female_row['total'];
													row_string += "<td>" + adult_female_row['total'] + "</td><td>" + (Math.ceil(100 * ((adult_female_row['total'] / regimen_totals[passed_regimen]) * 100)) / 100) + "</td>";
												} else {
													row_string += "<td>-</td>";
												}
											} catch(e) {
												if(counter <= 1) {
													row_string += "<td>-</td><td>-</td>";
												}
											}

										}
										getRegimenStatisticNumbers(start_date, end_date, "child", "1", passed_regimen, passed_regimen_name, function(transaction3, results3) {
											counter = 0;
											for(var i = 1; i <= 2; i++) {
												counter++;
												try {
													var child_male_row = results3.rows.item(i);
													if(child_male_row['name'] != null) {
														total_child_male_art += child_male_row['total'];
														row_string += "<td>" + child_male_row['total'] + "</td><td>" + (Math.ceil(100 * ((child_male_row['total'] / regimen_totals[passed_regimen]) * 100)) / 100) + "</td>";

													} else {
														row_string += "<td>-</td>";
													}
												} catch(e) {
													if(counter <= 1) {
														row_string += "<td>-</td><td>-</td>";
													}
												}

											}
											getRegimenStatisticNumbers(start_date, end_date, "child", "2", passed_regimen, passed_regimen_name, function(transaction4, results4) {
												returned_counter++;
												counter = 0;
												for(var i = 1; i <= 2; i++) {
													counter++;
													try {
														var child_female_row = results4.rows.item(i);
														if(child_female_row['name'] != null) {
															total_child_female_art += child_female_row['total'];
															row_string += "<td>" + child_female_row['total'] + "</td><td>" + (Math.ceil(100 * ((child_female_row['total'] / regimen_totals[passed_regimen]) * 100)) / 100) + "</td>";
														} else {
															row_string += "<td>-</td>";
														}

													} catch(e) {
														if(counter <= 1) {
															row_string += "<td>-</td><td>-</td>";
														}
													}

												}
												row_string += "</tr>";
												if(returned_counter == results0.rows.length) {
													row_string += "<tr class='tfoot'><td>Total:</td><td><b>" + total_patients + "</b></td><td><b>100</b></td><td><b>" + total_adult_male_art + "</b></td><td><b>" + (Math.ceil(100 * ((total_adult_male_art / total_patients) * 100)) / 100) + "</b></td><td><b>" + total_adult_female_art + "</b></td><td><b>" + (Math.ceil(100 * ((total_adult_female_art / total_patients) * 100)) / 100) + "</b></td><td><b>" + total_child_male_art + "</b></td><td><b>" + (Math.ceil(100 * ((total_child_male_art / total_patients) * 100)) / 100) + "</b></td><td><b>" + total_child_female_art + "</b></td><td><b>" + (Math.ceil(100 * ((total_child_female_art / total_patients) * 100)) / 100) + "</b></td></tr>";
												}
												$("#patient_listing").append($(row_string));
											});
										});
									});
								});
							}
						});
					});
				});
				
				$("#start_date").click(function(){
					$("#edit_selected_report").attr("value","patients_enrolled_in_art");
					$("#edit_donor_date_range_report").dialog("open");
				});
				$("#end_date").click(function(){
					$("#edit_selected_report").attr("value","patients_enrolled_in_art");
					$("#edit_donor_date_range_report").dialog("open");
				});
				
				$("#edit_donor_date_range_from").datepicker({
					changeMonth : true,
					changeYear : true,
					dateFormat : 'yy-mm-dd'
				});
				$("#edit_donor_date_range_to").datepicker({
					changeMonth : true,
					changeYear : true,
					dateFormat : 'yy-mm-dd'
				});
				$("#edit_donor_generate_date_range_report").click(function() {
					var report = $("#edit_selected_report").attr("value") + ".html#";
					var from = $("#edit_donor_date_range_from").attr("value");
					var to = $("#edit_donor_date_range_to").attr("value");
					var donor = $("#donor").attr("value");
					
					var report_url = report + "?start_date=" + from + "&end_date=" + to + "&donor=" + donor;
					
					if(from!="" && to!=""){
						window.location = report_url;
						location.reload();
					}
					else{
						alert("Please fill in the date before generating the report !");
					}
					
				});
				$("#edit_donor_date_range_report").dialog({
					autoOpen : false,
					modal : true,
					width:450
				});
			});
			function getAge(dateString) {
				var today = new Date();
				var birthDate = new Date(dateString);
				var age = today.getFullYear() - birthDate.getFullYear();
				var m = today.getMonth() - birthDate.getMonth();
				if(m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
					age--;
				}
				if(isNaN(age)) {
					return "N/A";
				}
				return age;
			}
		</script>
		
		<style>
			#patient_listing {
				margin: 0 auto;
				font-size: 14px;
				letter-spacing: 0.5px;
				width: 1200px;
				border-collapse:collapse;
			}
		
			#patient_listing td  {
				text-align: justify;
			}
			
		    .report_title {
				color:rgb(34, 86, 253);
				letter-spacing: 1px;
			}
			.tfoot{
				background-color:#DDD;
				font-weight: bold;
				font-size:16px;
			}
			th{
				background-color: #CFF;
				text-transform: uppercase;
				font-weight: bold;
				font-size:16px;
			}
		</style>
	</head>
	<body>
		
		<!-- Menus -->
		<div class="navbar ">
		  <div class="navbar-inner">
		    <div class="container">
		 
		      <!-- Everything you want hidden at 940px or less, place within here -->
		      <div class="nav-collapse collapse" id="acdmenu">
		      	<a class="brand" href="../reports.html"/><img src="../Images/home-icon.png"> | </a>
		        <ul class="nav">
				  <li class="dropdown">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="standard_report">
				     Standard Reports
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="standard_report_sub">
				      <li><a href="#" id="patients_enrolled_in_period" class="report donor_date_range_report active_report">Number of Patients Enrolled in Period</a></li>
				      <li><a href="#" id="patients_enrolled_in_art" class="report donor_date_range_report active_report">Number of Patients Started on ART in the Period</a></li>
				      <li><a href="#" id="graph_patients_enrolled_in_year" class="report active_report annual_report">Graph of Number of Patients Enrolled Per Month in a Given Year</a></li>
				      <li><a href="#" id="cumulative_patients" class="report active_report single_date_report">Cumulative Number of Patients to Date</a></li>
				      <li><a href="#" id="patients_on_ART_active" class="report active_report single_date_report">Number of Active Patients Receiving ART (by Regimen)</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical" id="visiting_patient">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
				     Visiting Patients
				    <b class="caret"></b>
				    </a>
				     <ul class="dropdown-menu" id="visiting_patient_sub">
				      <li><a href="#" id="patients_scheduled_to_visit" class="report active_report date_range_report">List of Patients Scheduled to Visit</a></li>
				      <li><a href="#" id="patients_started_on_date" class="report active_report date_range_report">List of Patients Started (on a Particular Date)</a></li>
				      <li><a href="#" id="patients_visitied_for_refill" class="report active_report date_range_report">List of Patients Visited for Refill</a></li>
				      <li><a href="#" id="patients_missing_appointments" class="report active_report date_range_report">Patients Missing Appointments</a></li>
				      <li><a href="#" id="patients_adherence" class="report active_report date_range_report">Patients Adherence Report</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="early_warning">
				     Early Warning Indicators
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu " id="early_warning_sub">
				      <li><a href="#" id="patients_who_changed_regimen" class="report active_report date_range_report">Active Patients who Have Changed Regimens</a></li>
				      <li><a href="#" id="patients_starting" class="report active_report date_range_report">List of Patients Starting (By Regimen)</a></li>
				      <li><a href="#" id="early_warning_indicators" class="report active_report date_range_report">HIV Early Warning Indicators</a></li>
				      <li><a href="#" id="service_statistics" class="report active_report single_date_report">Service Statistics (By Regimen)</a></li>
				     
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="drug_inventory">
				     Drug Inventory
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="drug_inventory_sub">
				      <li><a href="#" id="drug_consumption" class="report active_report annual_report">Drug Consumption Report</a></li>
				      <li><a href="#" id="drug_stock_on_hand" class="report active_report no_filter">Drug Stock on Hand Report</a></li>
				      <li><a href="#" id="commodity_summary" class="report active_report date_range_report">Facility Summary Commodity Report</a></li>
				      <li><a href="#" id="expiring_drugs" class="report active_report no_filter">Short Dated Stocks &lt;6 Months to Expiry</a></li>
				      <li><a href="#" id="expired_drugs" class="report active_report no_filter">List of Expired Drugs</a></li>
				    </ul>
				  </li>
				</ul>
		        <a onClick="window.print()" class="brand" title="Print this page"/> | <img src="../Images/printing_icon.png"> </a>
		      </div>
		 
		    </div>
		  </div>
		</div>
		<!-- Menus end -->
		
		<h2 id="facility_name" style="text-align: center"></h2>
		<h4 style="text-align: center">Listing of Patients Started on ART in the period  
		<br><br>
		From <input type="text" id="start_date"> to <input type="text" id="end_date"></h4>
		<hr size="1" style="width:80%">
		
		<table   id="patient_listing" border="1" cellpadding="5">
			<tr class="table_title">
				<th rowspan="3">Regimen</th>
				<th colspan="2">Total</th>
				<th colspan="4"> Adult</th>
				<th colspan="4"> Children </th>
			</tr>
			<tr class="table_subtitle">
				<th rowspan="2">No.</th>
				<th rowspan="2">%</th>
				<th colspan="2">Male</th>
				<th colspan="2">Female</th>
				<th colspan="2">Male</th>
				<th colspan="2">Female</th>
			</tr>
			<tr class="table_subsubtitle">
				<th>No.</th>
				<th>%</th>
				<th>No.</th>
				<th>%</th><th>No.</th>
				<th>%</th><th>No.</th>
				<th>%</th>
			</tr>
		</table>
		<input type="hidden" id="edit_selected_report" />
		<div id="edit_donor_date_range_report" title="Select Date Range and Donor">
			<table>
				<tr><td><strong class="label">Select Donor: </strong></td>
					<td>
						<select name="donor" id="donor">
							<option value="0">All Donors</option><option value="1">GOK</option><option value="2">PEPFAR</option>
						</select>
					</td>
				</tr>
				<tr><td><strong class="label">From: </strong></td>
					<td><input type="text"name="edit_donor_date_range_from" id="edit_donor_date_range_from"></td>
				</tr>
				<tr><td><strong class="label">To: </strong></td>
					<td><input type="text"name="edit_donor_date_range_to" id="edit_donor_date_range_to"></td>
				</tr>
			</table>
			<button id="edit_donor_generate_date_range_report" class="action_button" style="height:30px; font-size: 13px; width: 200px;">
				Generate Report
			</button>
		</div>
		
		
		<!-- Pop up Window -->
		<div class="result"></div>
		<!-- Pop up Window end-->
	</body>
</html>