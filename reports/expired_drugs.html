<!DOCTYPE html>
<html lang="en" >
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Expired Drugs Report</title>
		<link href="../CSS/style.css" type="text/css" rel="stylesheet"/>
		<link rel="SHORTCUT ICON" href="../Images/favicon.ico">
		<link href="../Scripts/bootstrap/css/bootstrap.min.css" type="text/css" rel="stylesheet" media="screen"/>
		<link href="../CSS/offline_css.css" type="text/css" rel="stylesheet"/>
		<link href="../CSS/jquery-ui.css" type="text/css" rel="stylesheet"/>
		<link href="TableFilter/filtergrid.css" type="text/css" rel="stylesheet"/>
		<script type="text/javascript" src="../Scripts/jquery.js"></script>
		<script type="text/javascript" src="../Scripts/jquery-ui.js"></script>
		<script type="text/javascript" src="../Scripts/offline_database.js"></script>
		<script type="text/javascript" src="../Scripts/offlineData.js"></script>
		<script type="text/javascript" src="TableFilter/tablefilter_all.js"></script>
		<script>
			$(document).ready(function(){
				$.get('reports_include.html', function(data) {
				  $('.result').html(data);
				});
			});
		</script>
		<script type="text/javascript">
			$(document).ready(function() {
				
				var count=0;
				initDatabase();
				var $_GET = getQueryParams(document.location.hash);
				var stock_type=$_GET['stock_type'];
				var type_title="";
				if(stock_type=="1"){
					type_title="Main Store";
				}
				else if(stock_type="2"){
					type_title="Pharmacy";
				}
				//Get the environmental variables to display the hospital name
				selectEnvironmentVariables(function(transaction, results) {
					var stocks_unconverted = 0;
					var soh_packs = 0;
					var minimum_stock = 0;
					var minimum_consumption = 0;
					var stock_status = 0;
					var d = new Date();
					var dat = ("0" + d.getDate()).slice(-2);
					var year = d.getFullYear();
					var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
					var mon = monthNames[d.getMonth()];
					var theday = dat + "-" + mon + "-" + year;
					var counter=0;
					$("#theday").text(theday);

					// Handle the results
					var row = results.rows.item(0);
					$("#facility_name").text(row['facility_name']+ " - "+type_title );
					var facility = row['facility'];

					var drug_statistics;
					//Retrieve all drugs in the database
					var drug_count = 1;

					var drugs_sql = "SELECT s.id AS id,s.drug AS Drug_Id,d.drug AS Drug_Name,d.pack_size AS pack_size, u.name AS Unit, s.batch_number AS Batch,s.expiry_date AS Date_Expired,(julianday(Date('now')) - julianday(s.expiry_date)) AS Days_Since_Expiry FROM drugcode d LEFT JOIN drug_unit u ON d.unit = u.id LEFT JOIN drug_stock_movement s ON d.id = s.drug LEFT JOIN transaction_type t ON t.id=s.transaction_type WHERE t.effect=1 AND strftime('%Y%m%d', date()) - strftime('%Y%m%d', s.expiry_date ) >=0 AND d.enabled=1 AND s.facility ='" + facility + "' GROUP BY Batch ORDER BY id";
					SQLExecuteAbstraction(drugs_sql, function(transaction, results) {
						for(var i = 0; i < results.rows.length; i++) {
							var parent_row = results.rows.item(i);

							getBatchInfo(parent_row['Drug_Id'], parent_row['Batch'], parent_row['Unit'], parent_row['Drug_Name'], parent_row['Date_Expired'], parent_row['Days_Since_Expiry'], parent_row['id'], parent_row['pack_size']);

						}
						if(results.rows.length == 0) {
							var batch_status_row_string = "<tr><td colspan='12' align='center'><b><h3>No Drugs Have Expired</h3></b></td></tr>";
							$("#drug_listing").append($(batch_status_row_string));
						}

					});
					function numberWithCommas(x) {
						return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
					}

					function getBatchInfo(drug, batch, drug_unit, drug_name, expiry_date, expired_days, drug_id, pack_size) {
						var stock_status = 0;
						var stock_param="";
						//Store
						if(stock_type=='1'){
							stock_param=" AND (source='"+facility+"' OR destination='"+facility+"') AND source!=destination ";
						}
						//Pharmacy
						else if(stock_type=='2'){
							stock_param=" AND (source=destination) AND(source='"+facility+"') ";
						}
						//Query to check if batch has had a physical count
						selectEnvironmentVariables(function(transaction, results) {
							// Handle the results
							var row = results.rows.item(0);
							var facility = row['facility'];

							var initial_stock_sql = "SELECT SUM( d.quantity ) AS Initial_stock, d.transaction_date AS transaction_date, '" + batch + "' AS batch FROM drug_stock_movement d WHERE d.drug =  '" + drug + "' AND facility='" + facility + "' "+stock_param+" AND transaction_type =  '11' AND d.batch_number =  '" + batch + "'";

							SQLExecuteAbstraction(initial_stock_sql, function(transaction, results) {
								for(var m = 0; m < results.rows.length; m++) {
									var physical_row = results.rows.item(m);
									initial_stock = physical_row['Initial_stock'];
									//Check if initial stock is present meaning physical count done
									if(initial_stock != null) {
										batch_stock_sql = "SELECT (SUM( ds.quantity ) - SUM( ds.quantity_out )) AS stock_levels, ds.batch_number FROM drug_stock_movement ds WHERE ds.transaction_date BETWEEN  '" + physical_row['transaction_date'] + "' AND date() AND facility='" + facility + "' "+stock_param+" AND ds.drug ='" + drug + "'  AND ds.batch_number ='" + physical_row['batch'] + "'";
										SQLExecuteAbstraction(batch_stock_sql, function(transaction, results) {
											for(var j = 0; j < results.rows.length; j++) {
												var second_row = results.rows.item(j);
												//console.log(second_row)
												if(second_row['stock_levels'] > 0) {
													counter++;
													batch_balance = second_row['stock_levels'];
													if(expired_days.toString().substring(0, 1) == "-") {
														expired_days = expired_days;
													}

													var batch_stock = batch_balance / pack_size;
													var expired_days_display = numberWithCommas(expired_days);
													var stocks_display = numberWithCommas(batch_stock.toFixed(1));
													var x="";
													if(counter%2==0){
														x="class='_even'";
													}
													else{
														x="class='_odd'";
													}
													var batch_status_row_string = "<tr "+x+"><td align='center'>" + drug_count + "</td><td>" + drug_name + "</td><td align='center'>" + drug_unit + "</td><td align='center'>" + batch + "</td><td align='center'>" + expiry_date + "</td><td align='center'>" + stocks_display + "</td><td align='center'>" + expired_days_display + "</td></tr>";
													$("#drug_listing").append($(batch_status_row_string));
													drug_count = drug_count + 1;
													count++;

												}
											}
										});
									} else {
										batch_stock_sql = "SELECT (SUM( ds.quantity ) - SUM( ds.quantity_out ) ) AS stock_levels, ds.batch_number FROM drug_stock_movement ds WHERE ds.drug =  '" + drug + "' AND facility='" + facility + "' "+stock_param+" AND ds.expiry_date > date() AND ds.batch_number='" + physical_row['batch'] + "'";
										//console.log(batch_stock_sql)
										SQLExecuteAbstraction(batch_stock_sql, function(transaction, results) {
											for(var j = 0; j < results.rows.length; j++) {
												var second_row = results.rows.item(j);

												if(second_row['stock_levels'] > 0) {
													counter++;
													batch_balance = second_row['stock_levels'];
													if(expired_days.toString().substring(0, 1) == "-") {
														expired_days = expired_days;
													}

													var batch_stock = batch_balance / pack_size;
													var expired_days_display = numberWithCommas(expired_days);
													var stocks_display = numberWithCommas(batch_stock.toFixed(1));
													var x="";
													if(counter%2==0){
														x="class='_even'";
													}
													else{
														x="class='_odd'";
													}
													var batch_status_row_string = "<tr "+x+"><td align='center'>" + drug_count + "</td><td>" + drug_name + "</td><td align='center'>" + drug_unit + "</td><td align='center'>" + batch + "</td><td align='center'>" + expiry_date + "</td><td align='center'>" + stocks_display + "</td><td align='center'>" + expired_days_display + "</td></tr>";
													$("#drug_listing").append($(batch_status_row_string));
													drug_count = drug_count + 1;
													count++;
												}

											}
										});
									}

								}

							});
						});
					}

				});
				
				var check_count=0;
				var previous_check_count=0;
				var z=0;
				var y=0;
				var interval=setInterval(function() {
					previous_check_count=count;
					if(check_count==0){
						if(y==0){
							y=1;
							check_count=previous_check_count;
						}
						else if(y==1){
							y==2;
							check_count=previous_check_count;
						}
						else if(y==2){
							clearInterval(interval);
						}
						
					}
					else{
						if(previous_check_count==check_count){
							if(z==0){
								z=1;
							}
							else if(z==1){
								clearInterval(interval);
								tableFilterDrugListing();
							}
							
						}
						else{
							z=0;
							check_count=previous_check_count;
						}
					}
					
				}, 3000);
			});
			
			function tableFilterDrugListing() {

					var props = {
						sort : true,
						//remember_grid_values : true,
						remember_page_number : true,
						//remember_page_length : true,
						filters_row_index : 1,
						alternate_rows : true,
						rows_counter : true,
						rows_counter_text : "Displayed rows: ",
						btn_reset : true,
						btn_reset_text : "Clear",
						loader : true,
						//status_bar : true,
						//btn_reset_text : "Clear",
						fixed_headers: true,
						mark_active_columns : true,
						col_0 : "none",
						col_1 : "select",
						col_2 : "select",
						col_3 : "select",
						col_4 : "select",
						col_5 : "select",
						col_6 : "select",
						paging:true,
						results_per_page : ['Results per page', [10, 25, 50, 100, 500,1000]],
			
						display_all_text : "< Show All >",
			
						col_width : ["30px", "300px", "100px", "100px", "100px", "100px", "100px", "100px"],
			
						//Column resize feature
						extensions : {
							name : ['ColumnsResizer'],
							src : ['TableFilter/TFExt_ColsResizer/TFExt_ColsResizer.js'],
							description : ['Columns Resizing'],
							initialize : [
							function(o) {
								o.SetColsResizer();
							}]
			
						},
						col_resizer_all_cells : false
					}
					var tf = setFilterGrid("drug_listing", props);
				}
	
			
		</script>
		<style>
			
			table#drug_listing{
				border-collapse:collapse;
				width:1200px;
			}
			#drug_listing {
				margin: 0 auto;
				border: 1px solid #B9B9B9;
				font-size: 14px;
				letter-spacing: 1px;
				border: 1px solid #000;
				border-top:none;
			}
			#drug_listing td th {
				padding: 10px;
			
			}
			
			#theday{
				color: rgb(45, 173, 13);
				font-size:14px;
				border:none;
				font-weight: 800;
				width:140px;
				padding-bottom:0px;
				height:25px;
			}
			#theday:hover{
				cursor:pointer;
			}
			td,th{
				border:1px solid #000;
				padding: 5px;
			}
			.inf{
				border-bottom: none;
			}
			select.pgSlc{
				height:30px;
				width:60px;
			}
			select.flt {
				font-size: 14px;
			}
			.stock_type_title{
				font-size:20px;
				font-weight:bolder;
				color:rgb(0, 197, 0);
			}
			#date_range_report table td,#single_date table td,#donor_date_range_report table td,#year table td{
				border:none;
			}
		</style>
	</head>
	<body>
		
		<!-- Menus -->
		<div class="navbar ">
		  <div class="navbar-inner">
		    <div class="container">
		 
		      <!-- Everything you want hidden at 940px or less, place within here -->
		      <div class="nav-collapse collapse" id="acdmenu">
		      	<a class="brand" href="../reports.html"/><img src="../Images/home-icon.png"> | </a>
		        <ul class="nav">
				  <li class="dropdown">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="standard_report">
				     Standard Reports
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="standard_report_sub">
				      <li><a href="#" id="patients_enrolled_in_period" class="report donor_date_range_report active_report">Number of Patients Enrolled in Period</a></li>
				      <li><a href="#" id="patients_enrolled_in_art" class="report donor_date_range_report active_report">Number of Patients Started on ART in the Period</a></li>
				      <li><a href="#" id="graph_patients_enrolled_in_year" class="report active_report annual_report">Graph of Number of Patients Enrolled Per Month in a Given Year</a></li>
				      <li><a href="#" id="cumulative_patients" class="report active_report single_date_report">Cumulative Number of Patients to Date</a></li>
				      <li><a href="#" id="patients_on_ART_active" class="report active_report single_date_report">Number of Active Patients Receiving ART (by Regimen)</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical" id="visiting_patient">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
				     Visiting Patients
				    <b class="caret"></b>
				    </a>
				     <ul class="dropdown-menu" id="visiting_patient_sub">
				      <li><a href="#" id="patients_scheduled_to_visit" class="report active_report date_range_report">List of Patients Scheduled to Visit</a></li>
				      <li><a href="#" id="patients_started_on_date" class="report active_report date_range_report">List of Patients Started (on a Particular Date)</a></li>
				      <li><a href="#" id="patients_visitied_for_refill" class="report active_report date_range_report">List of Patients Visited for Refill</a></li>
				      <li><a href="#" id="patients_missing_appointments" class="report active_report date_range_report">Patients Missing Appointments</a></li>
				      <li><a href="#" id="patients_adherence" class="report active_report date_range_report">Patients Adherence Report</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="early_warning">
				     Early Warning Indicators
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu " id="early_warning_sub">
				      <li><a href="#" id="patients_who_changed_regimen" class="report active_report date_range_report">Active Patients who Have Changed Regimens</a></li>
				      <li><a href="#" id="patients_starting" class="report active_report date_range_report">List of Patients Starting (By Regimen)</a></li>
				      <li><a href="#" id="early_warning_indicators" class="report active_report date_range_report">HIV Early Warning Indicators</a></li>
				      <li><a href="#" id="service_statistics" class="report active_report single_date_report">Service Statistics (By Regimen)</a></li>
				     
				    </ul>
				    <a onClick="window.print()" class="brand" title="Print this page"/> | <img src="../Images/printing_icon.png"> </a>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="drug_inventory">
				     Drug Inventory
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="drug_inventory_sub">
				      <li><a href="#" id="drug_consumption" class="report active_report annual_report">Drug Consumption Report</a></li>
				      <li><a href="#" id="drug_stock_on_hand" class="report active_report no_filter">Drug Stock on Hand Report</a></li>
				      <li><a href="#" id="commodity_summary" class="report active_report date_range_report">Facility Summary Commodity Report</a></li>
				      <li><a href="#" id="expiring_drugs" class="report active_report no_filter">Short Dated Stocks &lt;6 Months to Expiry</a></li>
				      <li><a href="#" id="expired_drugs" class="report active_report no_filter">List of Expired Drugs</a></li>
				    </ul>
				  </li>
				</ul>
		        
		      </div>
		 
		    </div>
		  </div>
		</div>
		<!-- Menus end -->
		
		<h2 id="facility_name" style="text-align: center"></h2>
		<h4 style="text-align: center">List of Expired Commodities as of <span id="theday"></span></h4>
		<table   id="drug_listing" class="sortable">
			<tr>
				<th> Id </th>
				<th> Commodity Name </th>
				<th> Unit </th>
				<th> Batch Number</th>
				<th> Date Expired </th>
				<th> Quantity Pks</th>
				<th> Days Since Expiry </th>
			</tr>
		</table>
		
		<!-- Pop up Window -->
		<div class="result"></div>
		<!-- Pop up Window end-->
		
	</body>
</html>