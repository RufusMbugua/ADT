<!DOCTYPE html>
<html lang="en" >
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Drug Consumption Report</title>
		<link href="../CSS/style.css" type="text/css" rel="stylesheet"/>
		<link rel="SHORTCUT ICON" href="../Images/favicon.ico">
		<link href="../Scripts/bootstrap/css/bootstrap.min.css" type="text/css" rel="stylesheet" media="screen"/>
		<link href="../CSS/offline_css.css" type="text/css" rel="stylesheet"/>
		<link href="../CSS/jquery-ui.css" type="text/css" rel="stylesheet"/>
		<link href="TableFilter/filtergrid.css" type="text/css" rel="stylesheet"/>
		
		<script type="text/javascript" src="../Scripts/jquery.js"></script>
		<script type="text/javascript" src="../Scripts/jquery-ui.js"></script>
		<script type="text/javascript" src="../Scripts/offline_database.js"></script>
		<script type="text/javascript" src="../Scripts/offlineData.js"></script>
		<script type="text/javascript" src="TableFilter/tablefilter_all.js"></script>
		<script>
			$(document).ready(function(){
				$.get('reports_include.html', function(data) {
				  $('.result').html(data);
				});
			});
		</script>
		
		
		<script type="text/javascript">
			$(document).ready(function() {
				var count=0;
				initDatabase();
				//Get the environmental variables to display the hospital name
				selectEnvironmentVariables(function(transaction, results) {
					var $_GET = getQueryParams(document.location.hash);
					var year = $_GET['year'];
					$("#_year").val(year);

					// Handle the results
					var row = results.rows.item(0);
					$("#facility_name").text(row['facility_name']);
                    var facility=row['facility'];
					var drug_statistics;
					//Retrieve all drugs in the database
					var drugs_sql = "select d.id as id,drug, pack_size, name from drugcode d left join drug_unit u on d.unit = u.id";
					SQLExecuteAbstraction(drugs_sql, function(transaction, result) {
						var counter = 0;
						
						for(var i = 0; i < result.rows.length; i++) {
							
							
							var parent_row = result.rows.item(i);
							var sql = "select '" + parent_row['drug'] + "' as drug_name,'" + parent_row['pack_size'] + "' as pack_size,'" + parent_row['name'] + "' as unit,strftime('%m',date(dispensing_date)) as month, sum(quantity) as total_consumed from patient_visit where drug_id = '" + parent_row['id'] + "' and dispensing_date like '%" + year + "%' and facility='"+facility+"' group by strftime('%m',date(dispensing_date)) order by strftime('%m',date(dispensing_date)) asc";
							//console.log(sql);
							SQLExecuteAbstraction(sql, function(transaction, results) {
								if(results.rows.length > 0) {
									
									count++;
									var first_row = results.rows.item(0);
									var drug_consumption = new Array();
									//First loop and make the month number as the array key
									for(var j = 0; j < results.rows.length; j++) {
										var parent_row = results.rows.item(j);
										var month = parent_row['month'];
										//Replace the preceding 0 in months less than october
										if(month < 10) {
											var month = parent_row['month'].replace('0', '');
										}
										drug_consumption[month] = parent_row['total_consumed'];
										
									}
									counter++;
									var x="";
									if(counter%2==0){
										x="class='_even'";
									}
									else{
										x="class='_odd'";
									}
									var row_string = "<tr "+x+"><td>" + first_row['drug_name'] + "</td><td>" + first_row['unit'] + "</td>";
									//Loop untill 12; check if there is a result for each month
									for(var x = 1; x <= 12; x++) {
										if(drug_consumption[x] && first_row['pack_size']) {
											row_string += "<td>" + Math.round(drug_consumption[x] / first_row['pack_size']) + "</td>";
										} else {
											row_string += "<td>-</td>";
										}
									}
									
									row_string += "</tr>";
									
									//$("#drug_listing").append($(row_string));
									$(row_string).appendTo("#drug_listing tbody").ready(function(){
										
									});
									
									
								}
								
							});
							
						}
						
					});
					
				});
				var check_count=0;
				var previous_check_count=0;
				var z=0;
				var interval=setInterval(function() {
					previous_check_count=count;
					if(check_count==0){
						check_count=previous_check_count;
					}
					else{
						if(previous_check_count==check_count){
							if(z==0){
								z=1;
							}
							else if(z==1){
								clearInterval(interval);
								tableFilterDrugListing();
							}
							
						}
						else{
							z=0;
							check_count=previous_check_count;
						}
					}
					
				}, 3000);
				
				function tableFilterDrugListing() {

					var props = {
						sort : true,
						//remember_grid_values : true,
						remember_page_number : true,
						//remember_page_length : true,
						filters_row_index : 1,
						alternate_rows : true,
						rows_counter : true,
						rows_counter_text : "Displayed rows: ",
						btn_reset : true,
						btn_reset_text : "Clear",
						loader : true,
						//status_bar : true,
						//btn_reset_text : "Clear",
						fixed_headers: true,
						mark_active_columns : true,
						col_0 : "select",
						col_1 : "select",
						col_2 : "none",
						col_3 : "none",
						col_4 : "none",
						col_5 : "none",
						col_6 : "none",
						col_7 : "none",
						col_8 : "none",
						col_9 : "none",
						col_10 : "none",
						col_11 : "none",
						col_12 : "none",
						col_13 : "none",
						col_14 : "none",
						paging:true,
						results_per_page : ['Results per page', [10, 25, 50, 100, 500,1000]],
			
						display_all_text : "< Show All >",
			
						col_width : ["300px", "90px", "50px", "50px", "50px", "50px", "50px", "50px","50px", "50px", "50px", "50px", "50px", "50px"],
			
						//Column resize feature
						extensions : {
							name : ['ColumnsResizer'],
							src : ['TableFilter/TFExt_ColsResizer/TFExt_ColsResizer.js'],
							description : ['Columns Resizing'],
							initialize : [
							function(o) {
								o.SetColsResizer();
							}]
			
						},
						col_resizer_all_cells : false
					}
					var tf = setFilterGrid("drug_listing", props);
				}
				
				$("#edit_year").dialog({
					autoOpen : false,
					modal : true
				});
				
				$("#edit_generate_single_year_report").click(function() {
					var report = $("#edit_selected_report").attr("value") + ".html#";
					var selected_year = $("#edit_single_year_filter").attr("value");
					var report_url = report + "?year=" + selected_year;
					window.location = report_url;
					location.reload();
				});
				
				$("#_year").click(function(){
					$("#edit_selected_report").attr("value", "drug_consumption");
					$("#edit_year").dialog("open");
				});
			});
			
		</script>
		<style>
			body{
				margin-bottom:20px;
			}
			#drug_listing {
				margin: 0 auto;
				border: 1px solid #B9B9B9;
				font-size: 14px;
				letter-spacing: 1px;
				border: 1px solid #000;
				border-top:none;
			}
			#drug_listing td th {
				padding: 10px;
			
			}
			table#drug_listing{
				border-collapse:collapse;
				width:1200px;
			}
			/* Sortable tables */
			table.sortable thead {
				background-color: #CFF;
				font-weight: bold;
				cursor: default;
				font-size:16px;
			}
			
			table#drug_listing td,table#drug_listing th{
				border:1px solid #000;
				padding: 5px;
			}
			#_year{
				color: rgb(45, 173, 13);
				font-size:14px;
				border:none;
				font-weight: 800;
				width:50px;
				padding-bottom:0px;
				height:25px;
			}
			#_year:hover{
				cursor:pointer;
			}
			.inf{
				border-bottom: none;
			}
			select.pgSlc{
				height:30px;
				width:60px;
			}
			select.flt {
				font-size: 14px;
			}
			#date_range_report table td,#single_date table td,#donor_date_range_report table td,#year table td{
				border:none;
			}
		</style>
	</head>
	<body>
		
		<!-- Menus -->
		<div class="navbar ">
		  <div class="navbar-inner">
		    <div class="container">
		 
		      <!-- Everything you want hidden at 940px or less, place within here -->
		      <div class="nav-collapse collapse" id="acdmenu">
		        <ul class="nav">
		          <a class="brand" href="../reports.html"/><img src="../Images/home-icon.png"> | </a>
				  <li class="dropdown">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="standard_report">
				     Standard Reports
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="standard_report_sub">
				      <li><a href="#" id="patients_enrolled_in_period" class="report donor_date_range_report active_report">Number of Patients Enrolled in Period</a></li>
				      <li><a href="#" id="patients_enrolled_in_art" class="report donor_date_range_report active_report">Number of Patients Started on ART in the Period</a></li>
				      <li><a href="#" id="graph_patients_enrolled_in_year" class="report active_report annual_report">Graph of Number of Patients Enrolled Per Month in a Given Year</a></li>
				      <li><a href="#" id="cumulative_patients" class="report active_report single_date_report">Cumulative Number of Patients to Date</a></li>
				      <li><a href="#" id="patients_on_ART_active" class="report active_report single_date_report">Number of Active Patients Receiving ART (by Regimen)</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical" id="visiting_patient">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
				     Visiting Patients
				    <b class="caret"></b>
				    </a>
				     <ul class="dropdown-menu" id="visiting_patient_sub">
				      <li><a href="#" id="patients_scheduled_to_visit" class="report active_report date_range_report">List of Patients Scheduled to Visit</a></li>
				      <li><a href="#" id="patients_started_on_date" class="report active_report date_range_report">List of Patients Started (on a Particular Date)</a></li>
				      <li><a href="#" id="patients_visitied_for_refill" class="report active_report date_range_report">List of Patients Visited for Refill</a></li>
				      <li><a href="#" id="patients_missing_appointments" class="report active_report date_range_report">Patients Missing Appointments</a></li>
				      <li><a href="#" id="patients_adherence" class="report active_report date_range_report">Patients Adherence Report</a></li>
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="early_warning">
				     Early Warning Indicators
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu " id="early_warning_sub">
				      <li><a href="#" id="patients_who_changed_regimen" class="report active_report date_range_report">Active Patients who Have Changed Regimens</a></li>
				      <li><a href="#" id="patients_starting" class="report active_report date_range_report">List of Patients Starting (By Regimen)</a></li>
				      <li><a href="#" id="early_warning_indicators" class="report active_report date_range_report">HIV Early Warning Indicators</a></li>
				      <li><a href="#" id="service_statistics" class="report active_report single_date_report">Service Statistics (By Regimen)</a></li>
				     
				    </ul>
				  </li>
				  <li class="dropdown divider-vertical">
				    <a href="#" class="dropdown-toggle" data-toggle="dropdown" id="drug_inventory">
				     Drug Inventory
				    <b class="caret"></b>
				    </a>
				    <ul class="dropdown-menu" id="drug_inventory_sub">
				      <li><a href="#" id="drug_consumption" class="report active_report annual_report">Drug Consumption Report</a></li>
				      <li><a href="#" id="drug_stock_on_hand" class="report active_report no_filter">Drug Stock on Hand Report</a></li>
				      <li><a href="#" id="commodity_summary" class="report active_report date_range_report">Facility Summary Commodity Report</a></li>
				      <li><a href="#" id="expiring_drugs" class="report active_report no_filter">Short Dated Stocks &lt;6 Months to Expiry</a></li>
				      <li><a href="#" id="expired_drugs" class="report active_report no_filter">List of Expired Drugs</a></li>
				    </ul>
				  </li>
				</ul>
		        <a onClick="window.print()" class="brand" title="Print this page"/> | <img src="../Images/printing_icon.png"> </a>
		      </div>
		 
		    </div>
		  </div>
		</div>
		<!-- Menus end -->
			
		<h2 id="facility_name" style="text-align: center"></h2>
		<h4 style="text-align: center;">Listing of Drug Consumption Report for <input type="text" class="_date" id="_year"> (in Packs)</h4>
		<hr size="1" style="width:80%">
		
		
		<table   id="drug_listing">
			<thead>
				<tr>
					<th> Drug </th>
					<th> Unit </th>
					<th> Jan </th>
					<th> Feb </th>
					<th> Mar </th>
					<th> Apr </th>
					<th> May </th>
					<th> Jun </th>
					<th> Jul </th>
					<th> Aug </th>
					<th> Sep </th>
					<th> Oct </th>
					<th> Nov </th>
					<th> Dec </th>
				</tr>
			</thead>
			<tbody></tbody>
			
		</table>
		
		<!-- Pop up Window -->
		<div id="edit_year">
			<label> <strong class="label">Report Year: </strong>
				<input type="text"name="filter_year" id="edit_single_year_filter">
			</label>
			<button id="edit_generate_single_year_report" class="action_button" style="height:30px; font-size: 13px; width: 200px;">
				Generate Report
			</button>
		</div>
		<div class="result"></div>
		<!-- Pop up Window end-->
		
	</body>
	
</html>